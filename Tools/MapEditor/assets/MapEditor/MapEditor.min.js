var MapEditor={ImagesURL:"assets/item/",ItemsURL:"items.json",LayersOpacity:!1,InactiveLayersOpacity:"0.8",MaxWidth:"100",MaxHeight:"100",Tool:1,Items:{},SelectedItem:null,Dragging:!1,init:function(){MapEditor.getItems(),$("#NewWorld",document).on("click",MapEditor.onNewWorldClick),$("#NewWorldModalSubmit",document).on("click",MapEditor.onNewWorldModalSubmit),$("#Eraser",document).on("click",MapEditor.onEraser),$("#Search",document).on("keyup",MapEditor.resortItemContainer),$("#Layer",document).on("change",MapEditor.resortItemContainer),$("#Layer",document).on("change",MapEditor.updateLayersOpacity),$("#SaveWorld",document).on("click",MapEditor.onSaveWorldClick),$("#File",document).on("change",MapEditor.onFile),MapEditor.onNewWorldClick(),MapEditor.rebind(),$(document).on("mousedown",function(e){MapEditor.Dragging=1==e.which}),$(document).on("mouseup",function(){MapEditor.Dragging=!1})},getItems:function(){$.get(MapEditor.ItemsURL+"?v="+Date.now(),function(e){MapEditor.Items=e,MapEditor.renderItemContainer()})},renderItemContainer:function(){for(var e in MapEditor.Items)if(MapEditor.Items.hasOwnProperty(e)){var t=MapEditor.Items[e],a=[];a.push('<div class="item-select" data-item-layer="'+t.Type+'" data-item-id="'+t.Id+'" data-item-name="'+t.Name+'">'),a.push('  <div class="item-select-icon">'),a.push('    <img alt="" src="'+MapEditor.ImagesURL+t.Id+'.png"/>'),a.push("  </div>"),a.push('  <div style="float: left; height: 64px; line-height: 64px; padding-left: 10px;">'+t.Name+"</div>"),a.push('  <div style="clear: both;"></div>'),a.push("</div>"),$(".item-container",document).append(a.join(""))}$(".item-select",document).on("click",function(){MapEditor.Tool=1,$(".item-select",document).removeClass("active"),$(this).addClass("active"),MapEditor.SelectedItem=MapEditor.Items[$(this).data("item-id")]}),$(".item-select",document).on("click mouseup mousedown mouseenter mouseout",function(){MapEditor.Dragging=!1}),MapEditor.resortItemContainer()},resortItemContainer:function(){var e=$("#Search").val().toLowerCase(),t=$("#Layer").val();$(".item-select",document).hide(),$(".item-select",document).each(function(){var a=$(this).data("item-layer"),i=$(this).data("item-name").toLowerCase();a==t&&(e&&!i.includes(e)||$(this).show())})},onNewWorldClick:function(){$("#NewWorldModal",document).modal("show")},onNewWorldModalSubmit:function(){var e=$("#NewWorldModal .modal-body",document),t=$('[name="Width"]',e),a=$('[name="Height"]',e);if(/^\+?(0|[1-9]\d*)$/.test(t.val())&&/^\+?(0|[1-9]\d*)$/.test(a.val()))if(parseInt(t.val())>MapEditor.MaxWidth||parseInt(t.val())<1||parseInt(a.val())>MapEditor.MaxHeight||parseInt(a.val())<1)alert("Width: min 1sqm, max "+MapEditor.MaxWidth+"sqm \n Height: min 1sqm, max "+MapEditor.MaxHeight+"sqm");else{$("#NewWorldModal",document).modal("hide");for(var i=[],o=0;o<a.val();o++){i.push('<div class="map-row">');for(var d=0;d<t.val();d++){var r=MapEditor.ImagesURL+"1000.png";i.push('<div class="sqm" data-x="'+(d+1)+'" data-y="'+(o+1)+'" data-item-id="1000" style="background-image: url('+r+');"></div>')}i.push("</div>")}$(".map-container",document).html(i.join("")),MapEditor.rebind()}else alert("put integers")},onSaveWorldClick:function(){var e={},t=$(".map-container",document);$(".sqm",t).each(function(t){var a=$(this),i=a.data("x"),o=a.data("y"),d=parseInt(a.data("item-id")),r=[];$(".item",a).each(function(){"item-preview"!=$(this).attr("id")&&r.push($(this).data("item-id"))}),e[o]||(e[o]={}),e[o][i]=[d,r]});var a=JSON.stringify(e);$.ajax({type:"POST",url:"save.php",data:{world:a}});var i=document.createElement("a");i.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),i.setAttribute("download","World.json"),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)},onFile:function(){if(this&&this.files&&0!==this.files.length){var e=new FileReader;new Promise((t,a)=>{e.onload=(e=>t(e.target.result)),e.onerror=(e=>a(e)),e.readAsText(this.files[0])}).then(e=>{try{e=JSON.parse(e)}catch(e){return void alert("The uploaded file is not a map file or has been damaged.")}MapEditor.renderWorld(e)})}},renderWorld:function(e){for(var t in $(".map-container",document).empty(),e)if(e.hasOwnProperty(t)){var a=e[t],i=[];for(var o in i.push('<div class="map-row">'),a)if(a.hasOwnProperty(o)){var d=a[o],r=MapEditor.ImagesURL+d[0]+".png";for(var n in i.push('<div class="sqm" data-x="'+o+'" data-y="'+t+'" data-item-id="'+d[0]+'" style="background-image: url('+r+');">'),d[1])if(d[1].hasOwnProperty(n)){var s=MapEditor.Items[d[1][n]];r=MapEditor.ImagesURL+s.Id+".png",i.push('<div class="item" data-layer="'+s.Type+'" data-item-id="'+s.Id+'" data-item-size="'+s.Size+'" style="background-image: url('+r+');"></div>')}i.push("</div>")}i.push("</div>"),$(".map-container",document).append(i.join(""))}MapEditor.rebind(),$("#Layer",document).trigger("change")},onEraser:function(){MapEditor.Tool=2,MapEditor.SelectedItem=null,$(".item-select",document).removeClass("active")},drawOnSQM:function(e){if(MapEditor.SelectedItem){var t;if(1==MapEditor.SelectedItem.Type)return t=MapEditor.ImagesURL+MapEditor.SelectedItem.Id+".png",e.data("item-id",MapEditor.SelectedItem.Id),void e.css("background-image","url("+t+")");var a=MapEditor.SelectedItem.Type;t=MapEditor.ImagesURL+MapEditor.SelectedItem.Id+".png",e.find('.item[data-layer="'+a+'"]').not($("#item-preview",document)).remove();var i='<div class="item" data-layer="'+a+'" data-item-id="'+MapEditor.SelectedItem.Id+'" data-item-size="'+MapEditor.SelectedItem.Size+'" style="background-image: url('+t+');"></div>',o=e.find(".item").not($("#item-preview",document)).filter(function(){return parseInt($(this).data("layer"))<a});o.last().length>0?$(i).insertAfter(o.last()):e.prepend(i)}},eraseOnSQM:function(e){e.find(".item").not($("#item-preview")).remove()},updateLayersOpacity:function(){if(MapEditor.LayersOpacity){var e=$(this).val();$("div.item",document).each(function(){$(this).data("layer")==e?$(this).css("opacity",1):$(this).css("opacity",MapEditor.InactiveLayersOpacity)})}},rebind:function(){var e=$(".sqm",document);e.unbind(),e.on("mouseenter",function(){$("#Coords",document).text("X: "+$(this).data("x")+", Y: "+$(this).data("y"))}),e.on("mouseenter",function(){var e;1===MapEditor.Tool&&MapEditor.SelectedItem&&(e=MapEditor.ImagesURL+MapEditor.SelectedItem.Id+".png",$("#item-preview",document).remove(),$(this).append('<div class="item" id="item-preview" data-item-size="'+MapEditor.SelectedItem.Size+'" style="background-image: url('+e+');"></div>')),2===MapEditor.Tool&&(e="assets/MapEditor/eraser.png",$("#item-preview",document).remove(),$(this).append('<div class="item" id="item-preview" data-item-size="1" style="background-image: url('+e+');"></div>'))}),e.on("mouseenter",function(){MapEditor.Dragging&&(1===MapEditor.Tool&&MapEditor.drawOnSQM($(this)),2===MapEditor.Tool&&MapEditor.eraseOnSQM($(this)))}),e.on("mousedown",function(e){1==e.which&&(1===MapEditor.Tool&&MapEditor.drawOnSQM($(this)),2===MapEditor.Tool&&MapEditor.eraseOnSQM($(this)))})}};